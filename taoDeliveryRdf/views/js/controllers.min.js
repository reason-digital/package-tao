define("taoDeliveryRdf/controller/routes",[],function(){"use strict";return{DeliveryMgmt:{actions:{editDelivery:"controller/DeliveryMgmt/editDelivery",excludeTesttaker:"controller/DeliveryMgmt/testtaker",wizard:"controller/DeliveryMgmt/wizard"}}}}),define("taoDeliveryRdf/controller/DeliveryMgmt/editDelivery",["jquery","helpers","ui/modal"],function($,helpers){"use strict";return{start:function(){$("#exclude-btn").click(function(){var delivery=$(this).data("delivery");$("#testtaker-form").load(helpers._url("excludeTesttaker","DeliveryMgmt","taoDeliveryRdf",{uri:delivery}),function(){$("body").prepend($("#modal-container")),$("#testtaker-form").modal()})})}}}),
define("taoDeliveryRdf/controller/DeliveryMgmt/testtaker",["jquery","i18n","helpers","module","layout/section","ui/feedback"],function($,__,helpers,module,section,feedback){"use strict";function switchList(){var target,current=$(this).parent().attr("id");"excludedList"==current?target=$("#assignedList"):"assignedList"==current&&(target=$("#excludedList")),"undefined"!=typeof target&&(target.append(this),this.scrollIntoView())}var timeout,$search=$("#tt-filter"),$list=$("#assignedList"),liveSearch=function(){var pattern=$search.val();clearTimeout(timeout),timeout=setTimeout(function(){filterList(new RegExp(pattern),$list)},300)},filterList=function(regex,list){
list.children().each(function(index,element){null===$(element).text().match(regex)?$(element).hide():$(element).show()})};return{start:function(){$("#save-tt").click(function(){var excluded=[];$("#excludedList > li").each(function(index){excluded.push($(this).data("uri"))});var assemblyUri=$('input[name="assemblyUri"]').val();$.ajax({url:helpers._url("saveExcluded","DeliveryMgmt","taoDeliveryRdf"),type:"POST",data:{uri:assemblyUri,excluded:JSON.stringify(excluded)},dataType:"json",success:function(response){response.saved&&(feedback().success(__("Selection saved successfully")),section.loadContentBlock(helpers._url("editDelivery","DeliveryMgmt","taoDeliveryRdf"),{
uri:assemblyUri}))}})}),$("#assignedList > li").click(switchList),$("#excludedList > li").click(switchList),$("#close-tt").click(function(){$("#testtaker-form").modal("close")}),$search.keyup(liveSearch).siblings(".ctrl").click(liveSearch)}}}),define("taoTaskQueue/model/taskQueueModel",["jquery","lodash","core/promise","core/eventifier","core/polling","core/dataProvider/request","jquery.fileDownload"],function($,_,Promise,eventifier,polling,request){"use strict";function hasSameState(task1,task2){return task1.status===task2.status||("created"===task1.status||"in_progress"===task1.status)&&("created"===task2.status||"in_progress"===task2.status)}var _defaults={
url:{get:"",archive:"",all:"",download:""},pollSingleIntervals:[{iteration:4,interval:1e3}],pollAllIntervals:[{iteration:10,interval:5e3},{iteration:0,interval:1e4}]};return function(config){var model,_cache,singlePollings={},getPollSingleIntervals=function(){if(config.pollSingleIntervals&&_.isArray(config.pollSingleIntervals))return _.cloneDeep(config.pollSingleIntervals)},getPollAllIntervals=function(){if(config.pollAllIntervals&&_.isArray(config.pollAllIntervals))return _.cloneDeep(config.pollAllIntervals)};return config=_.defaults(config||{},_defaults),model=eventifier({setEndpoints:function(urls){return _.assign(config.url,urls||{}),this},get:function(taskId){
var status;if(!config.url||!config.url.get)throw new TypeError("config.url.get is not configured while get() is being called");return status=request(config.url.get,{taskId:taskId},"GET",{},!0).then(function(taskData){return taskData&&taskData.status?(_cache?_cache[taskData.id]?hasSameState(_cache[taskData.id],taskData)||model.trigger("singletaskstatuschange",taskData):model.trigger("singletaskadded",taskData):_cache={},_cache[taskData.id]=taskData,taskData):Promise.reject(new Error("failed to get task data"))}),status.catch(function(err){model.trigger("error",err)}),status},getAll:function(){var status;if(!config.url||!config.url.all)throw new TypeError("config.url.all is not configured while getAll() is being called");
return status=request(config.url.all,{limit:100},"GET",{},!0).then(function(taskData){var newCache={};return taskData?(_cache?(_.forEach(taskData,function(task){var id=task.id;_cache[id]?hasSameState(_cache[id],task)||model.trigger("multitaskstatuschange",task):model.trigger("multitaskadded",task),newCache[id]=task}),_.forEach(_.difference(_.keys(_cache),_.keys(newCache)),function(id){model.trigger("taskremoved",_cache[id])})):_.forEach(taskData,function(task){newCache[task.id]=task}),_cache=newCache,taskData):Promise.reject(new Error("failed to get all task data"))}),status.catch(function(err){model.trigger("error",err)}),status},archive:function(taskId){var status;
if(!config.url||!config.url.archive)throw new TypeError("config.url.archive is not configured while archive() is being called");return status=request(config.url.archive,{taskId:taskId},"GET",{},!0),status.catch(function(res){model.trigger("error",res)}),status},pollAll:function(immediate){var self=this,loop=0,pollingIntervals=getPollAllIntervals(),_updateInterval=function(pollingInstance){var pollingInterval;loop?loop--:(pollingInterval=pollingIntervals.shift(),pollingInterval&&"undefined"!=typeof pollingInterval.iteration&&pollingInterval.interval&&(loop=pollingInterval.iteration,pollingInstance.setInterval(pollingInterval.interval)))};if(!config.url||!config.url.all)throw new TypeError("config.url.all is not configured while pollAll() is being called");
return this.globalPolling?(this.globalPolling.start(),this.trigger("pollAllStart")):(this.globalPolling=polling({action:function(){var statusArr,done=this.async();model.getAll().then(function(taskDataArray){return model.trigger("pollAll",taskDataArray),statusArr=_.map(taskDataArray,"status"),statusArr.indexOf("in_progress")===-1&&statusArr.indexOf("created")===-1?done.reject():(_updateInterval(self.globalPolling),void done.resolve())}).catch(function(){done.reject()})}}),_updateInterval(this.globalPolling),this.globalPolling.start(),this.trigger("pollAllStart")),immediate&&this.globalPolling.next(),model},pollAllStop:function(){return this.globalPolling&&(this.globalPolling.stop(),
this.trigger("pollAllStop")),this},pollSingle:function(taskId){var self=this,loop=0,pollingIntervals=getPollSingleIntervals(),_updateInterval=function(pollingInstance){var pollingInterval;return loop?(loop--,!0):(pollingInterval=pollingIntervals.shift(),!!(pollingInterval&&pollingInterval.iteration&&pollingInterval.interval)&&(loop=pollingInterval.iteration,pollingInstance.setInterval(pollingInterval.interval),!0))};if(!config.url||!config.url.get)throw new TypeError("config.url.get is not configured while pollSingle() is being called");return singlePollings[taskId]&&singlePollings[taskId].stop(),new Promise(function(resolve){var poll=polling({action:function(){
var done=this.async();self.get(taskId).then(function(taskData){"completed"===taskData.status||"failed"===taskData.status?(poll.stop(),self.trigger("pollSingleFinished",taskId,taskData),resolve({finished:!0,task:taskData})):_updateInterval(poll)?(self.trigger("pollSingle",taskId,taskData),done.resolve()):(self.trigger("pollSingleFinished",taskId,taskData),resolve({finished:!1,task:taskData}))}).catch(function(){done.reject()})}});_updateInterval(poll),singlePollings[taskId]=poll.start(),self.trigger("pollSingleStart",taskId)})},pollSingleStop:function(taskId){return singlePollings&&singlePollings[taskId]&&(singlePollings[taskId].stop(),this.trigger("pollSingleStop",taskId)),
this},create:function(url,data){var taskCreate,self=this;return taskCreate=request(url,data,"POST",{},!0).then(function(creationResult){return creationResult&&creationResult.task&&creationResult.task.id?(self.trigger("created",creationResult),self.pollSingle(creationResult.task.id).then(function(result){return creationResult.extra&&(result.extra=creationResult.extra),result.finished?self.trigger("fastFinished",result):self.trigger("enqueued",result),result})):Promise.reject(new Error("failed to get task data"))}),taskCreate.catch(function(err){model.trigger("error",err)}),taskCreate},download:function(taskId){if(!config.url||!config.url.download)throw new TypeError("config.url.download is not configured while download() is being called");
return new Promise(function(resolve,reject){$.fileDownload(config.url.download,{httpMethod:"POST",data:{taskId:taskId},successCallback:function(result){resolve(result)},failCallback:function(err){reject(err)}})})}})}}),define("taoTaskQueue/model/taskQueue",["util/url","taoTaskQueue/model/taskQueueModel"],function(urlHelper,taskQueueModelFactory){"use strict";return taskQueueModelFactory({url:{get:urlHelper.route("get","TaskQueueWebApi","taoTaskQueue"),archive:urlHelper.route("archive","TaskQueueWebApi","taoTaskQueue"),all:urlHelper.route("getAll","TaskQueueWebApi","taoTaskQueue"),download:urlHelper.route("download","TaskQueueWebApi","taoTaskQueue")},pollSingleIntervals:[{
iteration:3,interval:1e3}],pollAllIntervals:[{iteration:1,interval:8e3},{iteration:0,interval:5e3}]})}),define("tpl!taoTaskQueue/component/button/tpl/report",["handlebars"],function(hb){return hb.template(function(Handlebars,depth0,helpers,partials,data){this.compilerInfo=[4,">= 1.0.0"],helpers=this.merge(helpers,Handlebars.helpers),data=data||{};var stack1,helper,buffer="",functionType="function",escapeExpression=this.escapeExpression;return buffer+='<div class="task-report-container">\n    <div class="section-header flex-container-full">\n        <h2>',(helper=helpers.title)?stack1=helper.call(depth0,{hash:{},data:data}):(helper=depth0&&depth0.title,stack1=typeof helper===functionType?helper.call(depth0,{
hash:{},data:data}):helper),buffer+=escapeExpression(stack1)+'</h2>\n    </div>\n    <div class="main-container flex-container-full report"></div>\n</div>'})}),define("css!taoTaskQueue/component/button/css/taskable",[],function(){}),define("taoTaskQueue/component/button/taskable",["jquery","lodash","i18n","core/promise","ui/report","ui/feedback","layout/loading-bar","tpl!taoTaskQueue/component/button/tpl/report","css!taoTaskQueue/component/button/css/taskable"],function($,_,__,Promise,reportFactory,feedback,loadingBar,reportTpl){"use strict";var defaultConfig={},taskableComponent={setTaskConfig:function(config){return _.assign(this.config,config),this},createTask:function(){
var taskQueue,requestUrl,self=this,requestData={};return _.isFunction(this.config.taskCreationData)?requestData=this.config.taskCreationData.call(this):_.isPlainObject(this.config.taskCreationData)&&(requestData=this.config.taskCreationData),this.config.taskCreationUrl?(requestUrl=this.config.taskCreationUrl,this.config.taskQueue?(taskQueue=this.config.taskQueue,loadingBar.start(),taskQueue.pollAllStop(),void taskQueue.create(requestUrl,requestData).then(function(result){var infoBox,message,task=result.task;result.finished?task.hasFile?taskQueue.download(task.id).then(function(){return taskQueue.archive(task.id)}).then(function(){self.trigger("finished",result),
taskQueue.pollAll()}).catch(function(err){self.trigger("error",err),taskQueue.pollAll()}):taskQueue.archive(task.id).then(function(){self.trigger("finished",result),taskQueue.pollAll()}).catch(function(err){self.trigger("error",err),taskQueue.pollAll()}):(message=__("<strong> %s </strong> has been moved to the background.",task.taskLabel),infoBox=feedback(null,{encodeHtml:!1,timeout:{info:8e3}}).info(message),taskQueue.trigger("taskcreated",{task:task,sourceDom:infoBox.getElement()}),self.trigger("enqueued",result)),loadingBar.stop()}).catch(function(err){taskQueue.pollAll(),self.trigger("error",err)})):this.trigger("error","the taskQueue model is required to create a task")):this.trigger("error","the request url is required to create a task");
},displayReport:function(report,title,result){var $reportContainer,self=this;if(this.config.taskReportContainer instanceof $)return $reportContainer=$(reportTpl({title:title})),this.config.taskReportContainer.html($reportContainer),reportFactory({actions:[{id:"continue",icon:"right",title:"continue",label:__("Continue")}]},report).on("action-continue",function(){self.trigger("continue",result)}).render($reportContainer.find(".report"))}};return function(component,config){return _.assign(component,taskableComponent),component.off(".taskable").on("init.taskable",function(){_.defaults(this.config,config||{},defaultConfig)})}}),define("taoTaskQueue/component/button/standardButton",["jquery","lodash","i18n","core/promise","ui/report","ui/feedback","layout/loading-bar","ui/loadingButton/loadingButton","taoTaskQueue/component/button/taskable"],function($,_,__,Promise,reportFactory,feedback,loadingBar,loadingButton,makeTaskable){
"use strict";var defaultConfig={};return function(config){var component;return config=_.defaults(config||{},defaultConfig),component=makeTaskable(loadingButton(config)),component.on("started",function(){this.createTask()}).on("finished",function(){this.terminate().reset()}).on("enqueued",function(){this.terminate().reset()})}}),define("taoDeliveryRdf/controller/DeliveryMgmt/wizard",["lodash","jquery","i18n","ui/filter","ui/feedback","util/url","layout/actions","core/promise","taoTaskQueue/model/taskQueue","taoTaskQueue/component/button/standardButton"],function(_,$,__,filterFactory,feedback,urlUtils,actionManager,Promise,taskQueue,taskCreationButtonFactory){"use strict";
var provider={list:function(data){return new Promise(function(resolve,reject){$.ajax({url:urlUtils.route("getAvailableTests","DeliveryMgmt","taoDeliveryRdf"),data:{q:data.q,page:data.page},type:"GET",dataType:"JSON"}).done(function(tests){tests?resolve(tests):reject(new Error(__("Unable to load tests")))}).fail(function(){reject(new Error(__("Unable to load tests")))})})}},refreshTree=function(uriResource){actionManager.trigger("refresh",{uri:uriResource})};return{start:function(){var taskCreationButton,$oldSubmitter,$filterContainer=$(".test-select-container"),$formElement=$("#test"),$form=$("#simpleWizard"),$container=$form.closest(".content-block");filterFactory($filterContainer,{
placeholder:__("Select the test you want to publish to the test-takers"),width:"64%",quietMillis:1e3,label:__("Select the test")}).on("change",function(test){$formElement.val(test),test?taskCreationButton.enable():taskCreationButton.disable()}).on("request",function(params){provider.list(params.data).then(function(tests){params.success(tests)}).catch(function(err){params.error(err),feedback().error(err)})}).render("<%= text %>"),$oldSubmitter=$form.find(".form-submitter"),taskCreationButton=taskCreationButtonFactory({type:"info",icon:"delivery",title:__("Publish the test"),label:__("Publish"),taskQueue:taskQueue,taskCreationUrl:$form.prop("action"),taskCreationData:function(){
return $form.serializeArray()},taskReportContainer:$container}).on("finished",function(result){result.task&&result.task.report&&_.isArray(result.task.report.children)&&result.task.report.children.length&&result.task.report.children[0]&&(result.task.report.children[0].data&&result.task.report.children[0].data.uriResource?(feedback().info(__("%s completed",result.task.taskLabel)),refreshTree(result.task.report.children[0].data.uriResource)):this.displayReport(result.task.report.children[0],__("Error")))}).on("continue",function(){refreshTree()}).on("error",function(err){feedback().error(err)}).render($oldSubmitter.closest(".form-toolbar")).disable(),$oldSubmitter.replaceWith(taskCreationButton.getElement().css({
float:"right"}))}}}),function(c){var d=document,a="appendChild",i="styleSheet",s=d.createElement("style");s.type="text/css",d.getElementsByTagName("head")[0][a](s),s[i]?s[i].cssText=c:s[a](d.createTextNode(c))}("div.task-report-container{width:100%}\n\n/*# sourceMappingURL=taskable.css.map */");
//# sourceMappingURL=controllers.min.js.map